#!/bin/bash

function usage(){
  echo -e "error\ncurrect usage: \n./problem (name) -l (lang)"
}

function openFile(){
  if test ".problemconfig"; then
    re='^defaultapp:'
    while read line; do
      if [[ $line =~ $re ]]; then
        open -a"${line:12}" $1
        break
      fi
    done <.problemconfig
  else
    echo "missing .problemconfig"
    exit 1
  fi
}

if [ $# -eq 1 ]; then
  mkdir $1
  exit 0
fi

if [ $# -eq 3 ]; then
  if [ $2 == "-l" ]; then
    mkdir $1

    case $3 in
      cpp)
      touch "$1/makefile"
      echo -e "bin: main.cpp\n\tg++ -std=c++11 -Wall -Wextra -pedantic -O2 -o bin main.cpp" >> "$1/makefile"
      if test ".problemconfig"; then
        re='^cpp:'
        while read line; do
          if [[ $line =~ $re ]]; then
            touch "$1/${line:5}"
            openFile "$1/${line:5}"
            break
          fi
        done <.problemconfig
      else
        echo "missing .problemconfig"
        exit 1
      fi
      exit 0
      ;;

      python)
      if test ".problemconfig"; then
        re='^python:'
        while read line; do
          if [[ $line =~ $re ]]; then
            touch "$1/${line:8}"
            openFile "$1/${line:8}"
            break
          fi
        done <.problemconfig
      else
        echo "missing .problemconfig"
        exit 1
      fi
      exit 0
      ;;

      java)
      if test ".problemconfig"; then
        re='^java:'
        while read line; do
          if [[ $line =~ $re ]]; then
            touch "$1/${line:6}"
            openFile "$1/${line:6}"
            break
          fi
        done <.problemconfig
      else
        echo "missing .problemconfig"
        exit 1
      fi
      exit 0
      ;;

      *)
      echo -e"$(usage)"
      exit 1
      ;;
    esac
  fi
  echo -e "$(usage)"
  exit 1
fi

echo -e "$(usage)"
exit 1
